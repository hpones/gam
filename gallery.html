<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Galería</title>
<style>
  body {
    font-family: sans-serif;
    padding: 1rem;
    background: #111;
    color: white;
  }
  #items {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .item {
    position: relative;
    background: #222;
    border-radius: 6px;
    overflow: hidden;
    width: 180px;
    height: 120px;
    display: flex;
    flex-direction: column;
  }
  img, video {
    max-width: 100%;
    max-height: 100px;
    display: block;
    margin-bottom: 4px;
    object-fit: cover;
  }
  button {
    background: #444;
    border: none;
    color: white;
    cursor: pointer;
    padding: 6px 10px;
    margin: 0 2px;
    border-radius: 4px;
    font-size: 0.85rem;
  }
  .actions {
    display: flex;
    justify-content: center;
    gap: 5px;
  }
</style>
</head>
<body>
  <h2>Galería</h2>
  <div id="items"></div>

<script>
  const itemsDiv = document.getElementById('items');
  let mediaItems = [];

  function createDownloadLink(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.textContent = 'Descargar';
    a.style.color = 'white';
    a.onclick = () => setTimeout(() => URL.revokeObjectURL(url), 1000);
    return a;
  }

  function addItem(item) {
    mediaItems.push(item);
    renderItems();
  }

  function renderItems() {
    itemsDiv.innerHTML = '';
    mediaItems.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'item';

      if (item.type === 'photo') {
        const img = document.createElement('img');
        img.src = item.dataURL;
        div.appendChild(img);

        const downloadBtn = document.createElement('button');
        downloadBtn.textContent = 'Descargar';
        downloadBtn.onclick = () => {
          const a = document.createElement('a');
          a.href = item.dataURL;
          a.download = `foto_${index + 1}.png`;
          a.click();
        };

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Eliminar';
        deleteBtn.onclick = () => {
          mediaItems.splice(index, 1);
          renderItems();
        };

        const actions = document.createElement('div');
        actions.className = 'actions';
        actions.appendChild(downloadBtn);
        actions.appendChild(deleteBtn);
        div.appendChild(actions);

      } else if (item.type === 'video') {
        const video = document.createElement('video');
        video.controls = true;
        video.src = URL.createObjectURL(item.blob);
        div.appendChild(video);

        const downloadBtn = createDownloadLink(item.blob, `video_${index + 1}.webm`);

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Eliminar';
        deleteBtn.onclick = () => {
          mediaItems.splice(index, 1);
          renderItems();
        };

        const actions = document.createElement('div');
        actions.className = 'actions';
        actions.appendChild(downloadBtn);
        actions.appendChild(deleteBtn);
        div.appendChild(actions);
      }

      itemsDiv.appendChild(div);
    });
  }

  window.addEventListener('message', e => {
    if (e.data && e.data.type === 'addItem') {
      addItem(e.data.data);
    }
  });
</script>
</body>
</html>
