<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Experimental Camera</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .camera-container {
      flex: 1;
      position: relative;
      background: black;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    video, canvas#videoCanvas {
      max-width: 100%;
      max-height: 60vh;
      object-fit: cover;
      transform: scaleX(-1);
      user-select: none;
      background: black;
    }
    canvas#captureCanvas {
      display: none;
    }
    .bottom-controls {
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 10px;
      background: rgba(0,0,0,0.5);
      width: 100%;
    }
    .btn-circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      margin: 0 10px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 0;
      user-select: none;
    }
    .btn-circle.white { background: white; }
    .btn-circle.red { background: red; }
    .btn-circle.yellow { background: yellow; }
    .btn-circle.small-btn {
      width: 40px;
      height: 40px;
      font-size: 18px;
      background: white;
      color: black;
      margin: 0 5px;
      line-height: 1;
    }
    #filterList {
      position: absolute;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.8);
      color: black;
      list-style: none;
      padding: 5px 10px;
      border-radius: 10px;
      z-index: 10;
      max-width: 90vw;
      user-select: none;
    }
    #filterList.hidden {
      display: none;
    }
    #filterList li {
      padding: 5px;
      cursor: pointer;
      user-select: none;
    }
    #gallery {
      display: flex;
      flex-wrap: wrap;
      justify-content: start;
      align-items: flex-start;
      padding: 5px;
      background: #111;
      overflow-y: auto;
      max-height: 150px;
    }
    .thumb {
      width: 120px;
      height: auto;
      margin: 5px;
      object-fit: cover;
      border-radius: 8px;
      user-select: none;
    }
    #fullscreenBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,0,0.3);
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-weight: bold;
      font-size: 20px;
      color: black;
      z-index: 20;
      user-select: none;
      line-height: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background 0.3s;
    }
    #fullscreenBtn:hover {
      background: rgba(255,255,0,0.7);
    }
  </style>
</head>
<body>
  <main>
    <div class="camera-container" id="cameraContainer">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="videoCanvas"></canvas>
      <canvas id="captureCanvas"></canvas>
      <button id="fullscreenBtn" title="Pantalla completa">⬜</button>
      <div class="bottom-controls">
        <div class="capture-section">
          <button id="takePhoto" class="btn-circle white" title="Tomar foto"></button>
          <button id="startRecord" class="btn-circle red" title="Grabar video"></button>
        </div>
        <div class="filter-section">
          <button id="filterToggle" class="btn-circle yellow" title="Seleccionar filtro"></button>
          <ul id="filterList" class="hidden" aria-label="Lista de filtros">
            <li data-filter="none">Sin filtro</li>
            <li data-filter="grayscale">Gris</li>
            <li data-filter="invert">Invertir</li>
            <li data-filter="sepia">Sepia</li>
          </ul>
        </div>
      </div>
    </div>
    <section id="gallery" aria-label="Galería de fotos y videos"></section>
  </main>

  <script>
    const video = document.getElementById("video");
    const videoCanvas = document.getElementById("videoCanvas");
    const captureCanvas = document.getElementById("captureCanvas");
    const takePhotoBtn = document.getElementById("takePhoto");
    const startRecordBtn = document.getElementById("startRecord");
    const filterToggle = document.getElementById("filterToggle");
    const filterList = document.getElementById("filterList");
    const gallery = document.getElementById("gallery");
    const fullscreenBtn = document.getElementById("fullscreenBtn");
    const cameraContainer = document.getElementById("cameraContainer");

    let currentFilter = "none";
    let mediaStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let isRecording = false;
    let pauseBtn = null;
    let stopBtn = null;
    let facingMode = "user"; // front camera

    // Para grabar el video con filtro, dibujamos en videoCanvas y grabamos canvasStream
    let canvasStream = null;
    const videoCtx = videoCanvas.getContext("2d");
    const captureCtx = captureCanvas.getContext("2d");

    async function startCamera() {
      if(mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
      }
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: true });
        video.srcObject = mediaStream;

        video.addEventListener('loadedmetadata', () => {
          // Ajustar tamaños del canvas para dibujo
          videoCanvas.width = video.videoWidth;
          videoCanvas.height = video.videoHeight;
          captureCanvas.width = video.videoWidth;
          captureCanvas.height = video.videoHeight;
        });

        applyFilter(currentFilter);

        drawVideoToCanvas(); // iniciar el loop de dibujo

      } catch (err) {
        alert("No se pudo acceder a la cámara.");
        console.error(err);
      }
    }

    function applyFilter(filter) {
      currentFilter = filter;
      // Aplicar filtro CSS al video (vista en vivo)
      switch (filter) {
        case "grayscale": video.style.filter = "grayscale(1)"; break;
        case "invert": video.style.filter = "invert(1)"; break;
        case "sepia": video.style.filter = "sepia(1)"; break;
        default: video.style.filter = "none";
      }
    }

    // Dibuja el video con filtro en el canvas en loop para grabar
    function drawVideoToCanvas() {
      if (!video.paused && !video.ended) {
        videoCtx.save();
        videoCtx.clearRect(0, 0, videoCanvas.width, videoCanvas.height);
        videoCtx.filter = getCanvasFilter(currentFilter);

        // Flip horizontal para espejo (igual que el video)
        videoCtx.translate(videoCanvas.width, 0);
        videoCtx.scale(-1, 1);
        videoCtx.drawImage(video, 0, 0, videoCanvas.width, videoCanvas.height);

        videoCtx.restore();
      }
      requestAnimationFrame(drawVideoToCanvas);
    }

    function getCanvasFilter(filter) {
      switch(filter) {
        case "grayscale": return "grayscale(100%)";
        case "invert": return "invert(100%)";
        case "sepia": return "sepia(100%)";
        default: return "none";
      }
    }

    takePhotoBtn.addEventListener("click", () => {
      // Dibuja la imagen final con filtro en captureCanvas y la guarda
      captureCanvas.width = videoCanvas.width;
      captureCanvas.height = videoCanvas.height;

      captureCtx.save();
      captureCtx.clearRect(0, 0, captureCanvas.width, captureCanvas.height);
      captureCtx.filter = getCanvasFilter(currentFilter);
      captureCtx.translate(captureCanvas.width, 0);
      captureCtx.scale(-1, 1);
      captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
      captureCtx.restore();

      const imageUrl = captureCanvas.toDataURL("image/png");
      const img = document.createElement("img");
      img.src = imageUrl;
      img.classList.add("thumb");
      gallery.appendChild(img);
    });

    startRecordBtn.addEventListener("click", () => {
      if (!isRecording) {
        recordedChunks = [];
        // Obtener stream del canvas con el video y filtro aplicado
        canvasStream = videoCanvas.captureStream(30);
        // Añadir audio de la cámara al stream de canvas para grabar audio también
        if(mediaStream.getAudioTracks().length > 0){
          const audioTrack = mediaStream.getAudioTracks()[0];
          canvasStream.addTrack(audioTrack);
        }

        mediaRecorder = new MediaRecorder(canvasStream);
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: "video/webm" });
          const videoUrl = URL.createObjectURL(blob);
          const vid = document.createElement("video");
          vid.src = videoUrl;
          vid.controls = true;
          vid.classList.add("thumb");
          gallery.appendChild(vid);
        };
        mediaRecorder.start();
        isRecording = true;
        toggleRecordButtons();
      }
    });

    function toggleRecordButtons() {
      startRecordBtn.style.display = "none";

      pauseBtn = document.createElement("button");
      pauseBtn.className = "btn-circle small-btn";
      pauseBtn.innerText = "⏸️";
      pauseBtn.title = "Pausar/Reanudar";
      pauseBtn.onclick = () => {
        if (mediaRecorder.state === "recording") {
          mediaRecorder.pause();
          pauseBtn.innerText = "▶️";
        } else {
          mediaRecorder.resume();
          pauseBtn.innerText = "⏸️";
        }
      };

      stopBtn = document.createElement("button");
      stopBtn.className = "btn-circle small-btn";
      stopBtn.innerText = "⏹️";
      stopBtn.title = "Detener grabación";
      stopBtn.onclick = () => {
        mediaRecorder.stop();
        isRecording = false;
        pauseBtn.remove();
        stopBtn.remove();
        startRecordBtn.style.display = "inline-block";
      };

      const captureSection = document.querySelector(".capture-section");
      captureSection.appendChild(pauseBtn);
      captureSection.appendChild(stopBtn);
    }

    filterToggle.addEventListener("click", () => {
      filterList.classList.toggle("hidden");
    });

    filterList.addEventListener("click", e => {
      if (e.target.tagName === "LI") {
        applyFilter(e.target.dataset.filter);
        filterList.classList.add("hidden");
      }
    });

    fullscreenBtn.addEventListener("click", () => {
      if (!document.fullscreenElement) {
        cameraContainer.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    });

    // Iniciar cámara al cargar
    startCamera();
  </script>
</body>
</html>
