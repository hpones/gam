<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Experimental Camera</title>
<style>
  body {
    margin: 0;
    font-family: sans-serif;
    background: #000;
    color: #fff;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  main {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
  }
  .camera-container {
    flex: 1;
    background: black;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    overflow: hidden;
  }
  video, canvas#videoCanvas {
    max-width: 100%;
    max-height: 60vh;
    object-fit: cover;
    transform: scaleX(-1);
    user-select: none;
    background: black;
  }
  canvas#captureCanvas {
    display: none;
  }
  .bottom-controls {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(0,0,0,0.7);
    padding: 8px 0;
    display: flex;
    justify-content: center;
    gap: 20px;
    align-items: center;
    z-index: 10;
  }
  .btn-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 0;
    user-select: none;
  }
  .btn-circle.white { background: white; }
  .btn-circle.red { background: red; }
  .btn-circle.yellow { background: yellow; }
  .btn-circle.small-btn {
    width: 40px;
    height: 40px;
    font-size: 18px;
    background: white;
    color: black;
    margin: 0 5px;
    line-height: 1;
  }
  #filterList {
    position: absolute;
    bottom: 70px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.9);
    color: black;
    list-style: none;
    padding: 5px 10px;
    border-radius: 10px;
    max-width: 90vw;
    user-select: none;
    z-index: 20;
    box-shadow: 0 0 8px rgba(0,0,0,0.5);
  }
  #filterList.hidden {
    display: none;
  }
  #filterList li {
    padding: 5px 10px;
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
  }
  #filterList li:hover {
    background: #ff0;
  }
  #gallery {
    display: flex;
    flex-wrap: wrap;
    justify-content: start;
    align-items: flex-start;
    padding: 5px;
    background: #111;
    overflow-y: auto;
    max-height: 150px;
    margin-top: 8px;
  }
  .thumb {
    width: 120px;
    height: auto;
    margin: 5px;
    object-fit: cover;
    border-radius: 8px;
    user-select: none;
  }
  #fullscreenBtn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(255,255,0,0.3);
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    font-weight: bold;
    font-size: 20px;
    color: black;
    z-index: 20;
    user-select: none;
    line-height: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background 0.3s;
  }
  #fullscreenBtn:hover {
    background: rgba(255,255,0,0.7);
  }
</style>
</head>
<body>
  <main>
    <div class="camera-container" id="cameraContainer">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="videoCanvas"></canvas>
      <canvas id="captureCanvas"></canvas>
      <button id="fullscreenBtn" title="Pantalla completa">⬜</button>
      <div class="bottom-controls">
        <button id="takePhoto" class="btn-circle white" title="Tomar foto"></button>
        <button id="startRecord" class="btn-circle red" title="Grabar video"></button>
        <button id="filterToggle" class="btn-circle yellow" title="Seleccionar filtro"></button>
      </div>
      <ul id="filterList" class="hidden" aria-label="Lista de filtros">
        <li data-filter="none">Sin filtro</li>
        <li data-filter="grayscale">Gris</li>
        <li data-filter="invert">Invertir</li>
        <li data-filter="sepia">Sepia</li>
      </ul>
    </div>
    <section id="gallery" aria-label="Galería de fotos y videos"></section>
  </main>

  <script>
    const video = document.getElementById("video");
    const videoCanvas = document.getElementById("videoCanvas");
    const captureCanvas = document.getElementById("captureCanvas");
    const takePhotoBtn = document.getElementById("takePhoto");
    const startRecordBtn = document.getElementById("startRecord");
    const filterToggle = document.getElementById("filterToggle");
    const filterList = document.getElementById("filterList");
    const gallery = document.getElementById("gallery");
    const fullscreenBtn = document.getElementById("fullscreenBtn");
    const cameraContainer = document.getElementById("cameraContainer");

    let currentFilter = "none";
    let mediaStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let isRecording = false;
    let pauseBtn = null;
    let stopBtn = null;
    let facingMode = "user";

    let canvasStream = null;
    const videoCtx = videoCanvas.getContext("2d");
    const captureCtx = captureCanvas.getContext("2d");

    async function startCamera() {
      if(mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
      }
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: true });
        video.srcObject = mediaStream;

        video.addEventListener('loadedmetadata', () => {
          videoCanvas.width = video.videoWidth;
          videoCanvas.height = video.videoHeight;
          captureCanvas.width = video.videoWidth;
          captureCanvas.height = video.videoHeight;
        });

        applyFilter(currentFilter);
        drawVideoToCanvas();
      } catch (err) {
        alert("No se pudo acceder a la cámara.");
        console.error(err);
      }
    }

    function applyFilter(filter) {
      currentFilter = filter;
      switch (filter) {
        case "grayscale": video.style.filter = "grayscale(1)"; break;
        case "invert": video.style.filter = "invert(1)"; break;
        case "sepia": video.style.filter = "sepia(1)"; break;
        default: video.style.filter = "none";
      }
    }

    function drawVideoToCanvas() {
      if (!video.paused && !video.ended) {
        videoCtx.save();
        videoCtx.clearRect(0, 0, videoCanvas.width, videoCanvas.height);
        videoCtx.filter = getCanvasFilter(currentFilter);

        videoCtx.translate(videoCanvas.width, 0);
        videoCtx.scale(-1, 1);
        videoCtx.drawImage(video, 0, 0, videoCanvas.width, videoCanvas.height);
        videoCtx.restore();
      }
      requestAnimationFrame(drawVideoToCanvas);
    }

    function getCanvasFilter(filter) {
      switch(filter) {
        case "grayscale": return "grayscale(100%)";
        case "invert": return "invert(100%)";
        case "sepia": return "sepia(100%)";
        default: return "none";
      }
    }

    takePhotoBtn.addEventListener("click", () => {
      captureCanvas.width = videoCanvas.width;
      captureCanvas.height = videoCanvas.height;

      captureCtx.save();
      captureCtx.clearRect(0, 0, captureCanvas.width, captureCanvas.height);
      captureCtx.filter = getCanvasFilter(currentFilter);
      captureCtx.translate(captureCanvas.width, 0);
      captureCtx.scale(-1, 1);
      captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
      captureCtx.restore();

      const imageUrl = captureCanvas.toDataURL("image/png");
      const img = document.createElement("img");
      img.src = imageUrl;
      img.classList.add("thumb");
      gallery.appendChild(img);
    });

    startRecordBtn.addEventListener("click", () => {
      if (!isRecording) {
        recordedChunks = [];
        canvasStream = videoCanvas.captureStream(30);
        if(mediaStream.getAudioTracks().length > 0){
          const audioTrack = mediaStream.getAudioTracks()[0];
          canvasStream.addTrack(audioTrack);
        }
        mediaRecorder = new MediaRecorder(canvasStream);
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: "video/webm" });
          const videoUrl = URL.createObjectURL(blob);
          const vid = document.createElement("video");
          vid.src = videoUrl;
          vid.controls = true;
          vid.classList.add("thumb");
          gallery.appendChild(vid);
        };
        mediaRecorder.start();
        isRecording = true;
        toggleRecordButtons();
      }
    });

    function toggleRecordButtons() {
      startRecordBtn.disabled = isRecording;
      if (isRecording) {
        // Crear y mostrar botones pause y stop
        if(!pauseBtn){
          pauseBtn = document.createElement("button");
          pauseBtn.textContent = "⏸";
          pauseBtn.classList.add("btn-circle", "small-btn");
          pauseBtn.title = "Pausar/Reanudar grabación";
          pauseBtn.addEventListener("click", () => {
            if(mediaRecorder.state === "recording") mediaRecorder.pause();
            else if(mediaRecorder.state === "paused") mediaRecorder.resume();
          });
          document.querySelector(".bottom-controls").appendChild(pauseBtn);
        }
        if(!stopBtn){
          stopBtn = document.createElement("button");
          stopBtn.textContent = "⏹";
          stopBtn.classList.add("btn-circle", "small-btn");
          stopBtn.title = "Detener grabación";
          stopBtn.addEventListener("click", () => {
            mediaRecorder.stop();
            isRecording = false;
            toggleRecordButtons();
            if(pauseBtn) pauseBtn.remove();
            if(stopBtn) stopBtn.remove();
            pauseBtn = null;
            stopBtn = null;
          });
          document.querySelector(".bottom-controls").appendChild(stopBtn);
        }
      } else {
        // Remover botones pause y stop
        if(pauseBtn) pauseBtn.remove();
        if(stopBtn) stopBtn.remove();
        pauseBtn = null;
        stopBtn = null;
        startRecordBtn.disabled = false;
      }
    }

    filterToggle.addEventListener("click", () => {
      filterList.classList.toggle("hidden");
    });

    filterList.addEventListener("click", e => {
      if (e.target.tagName === "LI") {
        applyFilter(e.target.dataset.filter);
        filterList.classList.add("hidden");
      }
    });

    fullscreenBtn.addEventListener("click", () => {
      if (!document.fullscreenElement) {
        cameraContainer.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    });

    // Cambiar cámara con doble click en video
    video.addEventListener("dblclick", () => {
      facingMode = facingMode === "user" ? "environment" : "user";
      startCamera();
    });

    startCamera();
  </script>
</body>
</html>
